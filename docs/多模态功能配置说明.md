# 多模态功能配置说明

## 功能概述

本系统支持多种模态的文档处理，包括：

1. **图片OCR** - 从图片中提取文字
2. **表格解析** - 从Excel、PDF、图片中提取表格数据
3. **视频字幕** - 从视频中提取字幕和语音转文字
4. **音频转文字** - 将音频文件转换为文字

## 支持的文件格式

### 图片格式
- PNG (.png)
- JPEG (.jpg, .jpeg)
- GIF (.gif)
- BMP (.bmp)

### 表格格式
- Excel (.xlsx, .xls)
- CSV (.csv)
- PDF中的表格

### 视频格式
- MP4 (.mp4)
- AVI (.avi)
- MOV (.mov)
- MKV (.mkv)

### 音频格式
- MP3 (.mp3)
- WAV (.wav)
- M4A (.m4a)
- FLAC (.flac)

## 配置说明

### 1. 环境变量配置

在 `.env.local` 文件中添加以下配置：

```bash
# 多模态配置
ENABLE_MULTIMODAL=true
USE_OCR=true
USE_TABLE_EXTRACTION=true
USE_VIDEO_SUBTITLE=true
USE_AUDIO_TRANSCRIPTION=true
```

### 2. 配置参数说明

| 参数 | 说明 | 默认值 | 可选值 |
|------|------|--------|--------|
| `ENABLE_MULTIMODAL` | 是否启用多模态功能 | `true` | `true`, `false` |
| `USE_OCR` | 是否启用OCR功能 | `true` | `true`, `false` |
| `USE_TABLE_EXTRACTION` | 是否启用表格提取 | `true` | `true`, `false` |
| `USE_VIDEO_SUBTITLE` | 是否启用视频字幕提取 | `true` | `true`, `false` |
| `USE_AUDIO_TRANSCRIPTION` | 是否启用音频转文字 | `true` | `true`, `false` |

## 安装依赖

### 基础依赖（必需）

```bash
pip install pytesseract pillow
```

### 表格提取依赖

```bash
# PDF表格提取
pip install camelot-py[cv]

# Excel表格提取
pip install pandas openpyxl
```

### 视频和音频处理依赖

```bash
# Whisper模型（视频字幕和音频转文字）
pip install openai-whisper
```

### PDF处理依赖

```bash
# PDF图片提取
pip install pymupdf
```

### Tesseract OCR安装

**macOS:**
```bash
brew install tesseract
brew install tesseract-lang
```

**Ubuntu/Debian:**
```bash
sudo apt-get install tesseract-ocr
sudo apt-get install tesseract-ocr-chi-sim
```

**Windows:**
1. 下载Tesseract安装包：https://github.com/tesseract-ocr/tesseract
2. 安装后添加到系统PATH

## 使用方法

### 1. 上传图片

**支持的格式：** PNG, JPEG, GIF, BMP

**处理流程：**
1. 上传图片文件
2. 系统自动进行OCR识别
3. 提取文字内容
4. 分块并存储到向量库

**示例：**
```
上传: screenshot.png
↓
OCR识别: "这是一张截图，包含..."
↓
分块存储: ["这是一张截图", "包含..."]
```

### 2. 上传表格

**支持的格式：** Excel, CSV, PDF中的表格

**处理流程：**
1. 上传表格文件
2. 系统提取表格数据
3. 转换为Markdown格式
4. 分块并存储到向量库

**示例：**
```
上传: data.xlsx
↓
表格提取: 
| 姓名 | 年龄 | 职位 |
|------|------|------|
| 张三 | 25 | 工程师 |
↓
Markdown转换:
| 姓名 | 年龄 | 职位 |
|------|------|------|
| 张三 | 25 | 工程师 |
↓
分块存储
```

### 3. 上传视频

**支持的格式：** MP4, AVI, MOV, MKV

**处理流程：**
1. 上传视频文件
2. 系统提取音频
3. 使用Whisper转文字
4. 按时间戳分块存储

**示例：**
```
上传: meeting.mp4
↓
音频提取
↓
语音转文字: "大家好，今天我们讨论..."
↓
分块存储（带时间戳）
```

### 4. 上传音频

**支持的格式：** MP3, WAV, M4A, FLAC

**处理流程：**
1. 上传音频文件
2. 使用Whisper转文字
3. 分块并存储到向量库

**示例：**
```
上传: recording.mp3
↓
语音转文字: "这是会议录音..."
↓
分块存储
```

## 性能优化

### 1. Whisper模型选择

Whisper提供多种模型，可根据需求选择：

| 模型 | 大小 | 速度 | 准确度 | 推荐场景 |
|------|------|------|--------|----------|
| tiny | 39MB | 最快 | 低 | 快速测试 |
| base | 74MB | 快 | 中等 | 日常使用（推荐） |
| small | 244MB | 中等 | 高 | 高质量需求 |
| medium | 769MB | 慢 | 很高 | 专业场景 |
| large | 1550MB | 很慢 | 最高 | 最高质量 |

**配置方法：**
修改 `src/core/multimodal_processor.py` 中的模型名称：
```python
self._whisper_model = whisper.load_model("base")  # 改为其他模型
```

### 2. OCR语言配置

支持多语言OCR：

```python
text = pytesseract.image_to_string(image, lang='chi_sim+eng')
```

**常用语言代码：**
- `chi_sim` - 简体中文
- `chi_tra` - 繁体中文
- `eng` - 英语
- `jpn` - 日语
- `kor` - 韩语

### 3. 批量处理优化

对于大量文件，建议：
1. 分批处理，避免内存溢出
2. 使用异步处理
3. 添加进度显示

## 故障排查

### 问题1：OCR识别失败

**错误信息：** `OCR处理失败`

**解决方案：**
1. 检查Tesseract是否正确安装
2. 检查语言包是否安装
3. 尝试使用更清晰的图片

```bash
# 检查Tesseract版本
tesseract --version

# 检查语言包
tesseract --list-langs
```

### 问题2：表格提取失败

**错误信息：** `表格提取失败`

**解决方案：**
1. 安装camelot依赖
2. 检查PDF是否可读
3. 尝试使用其他格式（如Excel）

```bash
pip install camelot-py[cv]
```

### 问题3：视频处理失败

**错误信息：** `视频字幕提取失败`

**解决方案：**
1. 安装ffmpeg
2. 检查视频格式是否支持
3. 尝试使用更小的视频文件

**macOS:**
```bash
brew install ffmpeg
```

**Ubuntu/Debian:**
```bash
sudo apt-get install ffmpeg
```

### 问题4：音频转文字失败

**错误信息：** `音频转文字失败`

**解决方案：**
1. 检查音频格式
2. 尝试使用更小的音频文件
3. 检查Whisper模型是否正确下载

## 代码位置

- **多模态处理器：** `src/core/multimodal_processor.py`
- **文档处理器：** `src/core/document_processor.py`
- **配置文件：** `src/config/settings.py`

## 使用示例

### Python代码示例

```python
from src.core.multimodal_processor import MultiModalProcessor

# 创建处理器
processor = MultiModalProcessor(
    use_ocr=True,
    use_table_extraction=True,
    use_video_subtitle=True,
    use_audio_transcription=True
)

# 处理图片
result = processor.process_image("screenshot.png")
print(result["text"])

# 处理表格
result = processor.process_table("data.xlsx")
for table in result["tables"]:
    print(table["markdown"])

# 处理视频
result = processor.process_video("meeting.mp4")
for subtitle in result["subtitles"]:
    print(f"{subtitle['start']}-{subtitle['end']}: {subtitle['text']}")

# 处理音频
result = processor.process_audio("recording.mp3")
print(result["text"])
```

## 注意事项

1. **文件大小限制**：建议单个文件不超过100MB
2. **处理时间**：视频和音频处理时间较长，请耐心等待
3. **资源占用**：Whisper模型需要较多内存，建议至少8GB
4. **网络要求**：首次使用会自动下载Whisper模型，约150MB
5. **隐私保护**：所有处理在本地进行，不会上传到云端

## 更新日志

### v1.0.0 (2024-01-30)
- ✅ 实现图片OCR功能
- ✅ 实现表格解析功能
- ✅ 实现视频字幕提取
- ✅ 实现音频转文字功能
- ✅ 支持多种文件格式
- ✅ 集成到文档处理流程