# 通义千问多模态服务配置说明

## 功能概述

本系统集成了通义千问大模型的多模态能力，提供高质量的多模态文档处理：

1. **通义千问VL** - 图片理解和文字提取
2. **通义千问** - 表格提取和理解
3. **通义听悟** - 音频和视频转文字

## 为什么选择通义千问大模型？

### 专门API vs 通义千问大模型对比

| 特性 | 专门API | 通义千问大模型 |
|------|----------|----------------|
| API Key数量 | 多个（OCR、NLS等） | 1个（通义千问） |
| 管理复杂度 | 高 | 低 |
| 灵活性 | 低（功能单一） | 高（多功能） |
| OCR成本 | 0.001元/次 | 0.008元/次 |
| 语音成本 | 0.002元/分钟 | 0.002元/分钟 |
| 表格提取 | 0.01元/页 | 0.008元/次 |
| 准确率 | 95-98% | 95-98% |
| 速度 | 快 | 稍慢 |

### 优势

✅ **一个API Key搞定所有** - 简化管理
✅ **灵活性更高** - 可以处理多种任务
✅ **成本差距不大** - OCR稍高，但整体可控
✅ **统一接口** - 所有功能使用相同的API
✅ **易于扩展** - 可以轻松添加新功能

## 配置说明

### 1. 获取通义千问API Key

1. 登录[阿里云百炼控制台](https://bailian.console.aliyun.com/)
2. 进入"API-KEY管理"
3. 创建API Key
4. 记录API Key

### 2. 环境变量配置

在 `.env.local` 文件中添加以下配置：

```bash
# 通义千问配置
DASHSCOPE_API_KEY=your_dashscope_api_key

# 多模态配置
ENABLE_MULTIMODAL=true
USE_OCR=true
USE_TABLE_EXTRACTION=true
USE_VIDEO_SUBTITLE=true
USE_AUDIO_TRANSCRIPTION=true
USE_ALIYUN_SERVICES=false
USE_QWEN_MODEL=true
```

### 3. 配置参数说明

| 参数 | 说明 | 默认值 | 可选值 |
|------|------|--------|--------|
| `DASHSCOPE_API_KEY` | 通义千问API Key | 必填 | 您的API Key |
| `USE_QWEN_MODEL` | 是否使用通义千问模型 | `true` | `true`, `false` |
| `USE_ALIYUN_SERVICES` | 是否使用阿里云专门服务 | `false` | `true`, `false` |

## 使用方法

### 1. 图片OCR

**支持的格式：** PNG, JPEG, GIF, BMP

**使用方式：**
- 上传图片文件
- 系统自动调用通义千问VL
- 提取文字内容并存储

**效果：**
- 中英文识别准确率95-98%
- 支持手写文字识别
- 支持表格识别
- 支持复杂布局

**成本：** 0.008元/次

### 2. 表格提取

**支持的格式：** Excel, CSV, 图片中的表格

**使用方式：**
- 上传表格文件
- 系统自动调用通义千问
- 提取表格数据并转换为Markdown

**效果：**
- 表格提取准确率95-98%
- 支持复杂表格结构
- 支持合并单元格
- 支持公式识别

**成本：** 0.008元/次

### 3. 音频转文字

**支持的格式：** MP3, WAV, M4A, FLAC

**使用方式：**
- 上传音频文件
- 系统自动调用通义听悟
- 转换为文字并存储

**效果：**
- 中文识别准确率98-99%
- 支持方言识别
- 支持多语言混合
- 支持说话人分离

**成本：** 0.002元/分钟

### 4. 视频处理

**支持的格式：** MP4, AVI, MOV, MKV

**使用方式：**
- 上传视频文件
- 系统提取音频
- 调用通义听悟识别
- 转换为文字并存储

**效果：**
- 语音识别准确率98-99%
- 支持时间戳
- 支持多语言
- 自动提取音频

**成本：** 0.002元/分钟

## 定价说明

### 通义千问VL（图片理解）

| 模型 | 价格 | 免费额度 |
|------|------|----------|
| qwen-vl-max | 0.008元/次 | 100次/月 |
| qwen-vl-plus | 0.004元/次 | 200次/月 |
| qwen-vl-turbo | 0.002元/次 | 500次/月 |

### 通义千问（文本和表格）

| 模型 | 价格 | 免费额度 |
|------|------|----------|
| qwen-max | 0.02元/次 | 100次/月 |
| qwen-plus | 0.008元/次 | 200次/月 |
| qwen-turbo | 0.002元/次 | 500次/月 |

### 通义听悟（语音识别）

| 模型 | 价格 | 免费额度 |
|------|------|----------|
| paraformer-v2 | 0.002元/分钟 | 60分钟/月 |
| paraformer-v1 | 0.001元/分钟 | 120分钟/月 |

## 代码位置

- **通义千问多模态处理器：** `src/core/qwen_multimodal.py`
- **多模态处理器：** `src/core/multimodal_processor.py`
- **文档处理器：** `src/core/document_processor.py`
- **配置文件：** `src/config/settings.py`

## 使用示例

### Python代码示例

```python
from src.core.qwen_multimodal import QwenMultiModalProcessor

# 创建处理器
processor = QwenMultiModalProcessor(
    api_key="your_dashscope_api_key",
    model="qwen-vl-max"
)

# 处理图片
result = processor.process_image("screenshot.png")
print(result["text"])

# 处理表格
result = processor.process_table("data.xlsx")
for table in result["tables"]:
    print(table["markdown"])

# 处理音频
result = processor.process_audio("recording.mp3")
print(result["text"])

# 处理视频
result = processor.process_video("meeting.mp4")
print(result["text"])
```

## 切换服务

### 从专门API切换到通义千问

1. 在 `.env.local` 中设置：
   ```bash
   USE_ALIYUN_SERVICES=false
   USE_QWEN_MODEL=true
   DASHSCOPE_API_KEY=your_api_key
   ```

2. 重启后端服务

### 从通义千问切换到专门API

1. 在 `.env.local` 中设置：
   ```bash
   USE_ALIYUN_SERVICES=true
   USE_QWEN_MODEL=false
   ALIBABA_CLOUD_ACCESS_KEY_ID=your_key_id
   ALIBABA_CLOUD_ACCESS_KEY_SECRET=your_key_secret
   ```

2. 重启后端服务

### 切换到免费方案

1. 在 `.env.local` 中设置：
   ```bash
   USE_ALIYUN_SERVICES=false
   USE_QWEN_MODEL=false
   ```

2. 安装免费方案依赖：
   ```bash
   pip install pytesseract pillow openai-whisper
   ```

3. 安装Tesseract OCR

## 注意事项

1. **API Key安全**：不要将API Key提交到代码仓库
2. **费用控制**：注意监控使用量，避免超支
3. **配额限制**：注意免费额度限制
4. **网络要求**：需要稳定的网络连接
5. **模型选择**：根据需求选择合适的模型

## 故障排查

### 问题1：API Key无效

**错误信息：** `API Key无效`

**解决方案：**
1. 检查API Key是否正确
2. 检查API Key是否有权限
3. 检查账户余额

### 问题2：配额不足

**错误信息：** `配额不足`

**解决方案：**
1. 检查免费额度
2. 购买付费配额
3. 等待配额重置

### 问题3：模型不支持

**错误信息：** `模型不支持`

**解决方案：**
1. 检查模型名称是否正确
2. 检查模型是否已开通
3. 使用其他模型

## 更新日志

### v1.0.0 (2024-01-30)
- ✅ 集成通义千问VL图片理解
- ✅ 集成通义千问表格提取
- ✅ 集成通义听悟语音识别
- ✅ 支持视频处理
- ✅ 添加配置参数
- ✅ 支持服务切换